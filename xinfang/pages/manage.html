<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鞍山市公安局民意感知中心平台 - 账号管理</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-edit, .btn-delete {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .btn-edit {
            background-color: var(--primary-color);
        }
        
        .btn-delete {
            background-color: var(--danger-color);
        }
        
        .user-role, .user-level {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: white;
        }
        
        .role-admin {
            background-color: var(--accent-color);
        }
        
        .role-user {
            background-color: var(--primary-color);
        }
        
        .level-city {
            background-color: var(--success-color);
        }
        
        .level-county {
            background-color: var(--warning-color);
            color: black;
        }
        
        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            flex: 1;
            margin-right: 10px;
        }
        
        .btn-add-user {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-add-user svg {
            width: 16px;
            height: 16px;
            fill: white;
        }
        
        /* 用户编辑模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .modal-close {
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <div class="navbar">
        <div class="container navbar-container">
            <div class="navbar-logo">鞍山市公安局民意感知中心平台</div>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">首页</a></li>
                <li><span id="user-name">用户名</span></li>
                <li><a href="#" id="logout-btn">退出</a></li>
            </ul>
        </div>
    </div>
    
    <!-- 主内容区 -->
    <div class="container">
        <div class="card">
            <h3 class="card-title">账号管理</h3>
            
            <div class="search-bar">
                <input type="text" id="search-user" class="form-control" placeholder="搜索用户名、姓名或部门...">
                <button class="btn btn-add-user" id="add-user-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                    </svg>
                    添加用户
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table" id="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>用户名</th>
                            <th>姓名</th>
                            <th>角色</th>
                            <th>级别</th>
                            <th>部门</th>
                            <th>联系方式</th>
                            <th>注册时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 用户列表将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 用户编辑模态框 -->
    <div class="modal" id="user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">添加用户</h3>
                <span class="modal-close">&times;</span>
            </div>
            
            <form id="user-form">
                <input type="hidden" id="user-id">
                
                <div class="form-group">
                    <label for="edit-fullname">姓名</label>
                    <input type="text" id="edit-fullname" class="form-control" placeholder="请输入真实姓名" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-username">用户名</label>
                    <input type="text" id="edit-username" class="form-control" placeholder="请输入用户名" required>
                    <small id="edit-username-error" style="color: red; display: none;">用户名已存在，请选择其他用户名</small>
                </div>
                
                <div class="form-group" id="password-group">
                    <label for="edit-password">密码</label>
                    <input type="password" id="edit-password" class="form-control" placeholder="请输入密码" required>
                    <small>密码长度至少6位，包含字母和数字</small>
                </div>
                
                <div class="form-group">
                    <label for="edit-role">用户角色</label>
                    <select id="edit-role" class="form-control" required>
                        <option value="user">普通用户</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-level">用户级别</label>
                    <select id="edit-level" class="form-control" required>
                        <option value="city">市级用户</option>
                        <option value="county">县(区)级用户</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-department">所属部门</label>
                    <input type="text" id="edit-department" class="form-control" placeholder="请输入所属部门" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-contact">联系方式</label>
                    <input type="text" id="edit-contact" class="form-control" placeholder="请输入手机号码" required>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn" style="background-color: #6c757d;" id="cancel-btn">取消</button>
                    <button type="submit" class="btn">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 添加脚本 -->
    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否具有管理员权限
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                const currentUser = JSON.parse(storedUser);
                if (currentUser.role !== 'admin') {
                    alert('您没有访问此页面的权限');
                    window.location.href = 'dashboard.html';
                    return;
                }
            }
            
            // 加载用户列表
            loadUserList();
            
            // 搜索功能
            const searchInput = document.getElementById('search-user');
            searchInput.addEventListener('input', function() {
                loadUserList(this.value);
            });
            
            // 添加用户按钮点击事件
            const addUserBtn = document.getElementById('add-user-btn');
            addUserBtn.addEventListener('click', function() {
                openUserModal();
            });
            
            // 模态框关闭按钮
            const modalClose = document.querySelector('.modal-close');
            modalClose.addEventListener('click', closeUserModal);
            
            // 取消按钮
            const cancelBtn = document.getElementById('cancel-btn');
            cancelBtn.addEventListener('click', closeUserModal);
            
            // 用户表单提交事件
            const userForm = document.getElementById('user-form');
            userForm.addEventListener('submit', handleUserFormSubmit);
            
            // 检查用户名是否已存在
            const editUsername = document.getElementById('edit-username');
            editUsername.addEventListener('blur', function() {
                checkUsernameExists(this.value);
            });
        });
        
        // 加载用户列表
        function loadUserList(searchTerm = '') {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const tableBody = document.querySelector('#users-table tbody');
            
            tableBody.innerHTML = '';
            
            let filteredUsers = users;
            
            // 如果有搜索词，进行过滤
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredUsers = users.filter(user => 
                    user.username.toLowerCase().includes(term) || 
                    user.name.toLowerCase().includes(term) || 
                    (user.department && user.department.toLowerCase().includes(term))
                );
            }
            
            filteredUsers.forEach(user => {
                const tr = document.createElement('tr');
                
                // 格式化注册时间
                let registerTime = user.registerTime ? new Date(user.registerTime).toLocaleString() : '-';
                
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.name}</td>
                    <td><span class="user-role role-${user.role}">${user.role === 'admin' ? '管理员' : '普通用户'}</span></td>
                    <td><span class="user-level level-${user.level}">${user.level === 'city' ? '市级' : '县级'}</span></td>
                    <td>${user.department || '-'}</td>
                    <td>${user.contact || '-'}</td>
                    <td>${registerTime}</td>
                    <td class="action-buttons">
                        <button class="btn btn-edit" data-id="${user.id}">编辑</button>
                        <button class="btn btn-delete" data-id="${user.id}">删除</button>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
            
            // 添加编辑和删除按钮事件监听
            const editButtons = document.querySelectorAll('.btn-edit');
            const deleteButtons = document.querySelectorAll('.btn-delete');
            
            editButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.dataset.id;
                    openUserModal(userId);
                });
            });
            
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.dataset.id;
                    deleteUser(userId);
                });
            });
        }
        
        // 打开用户编辑模态框
        function openUserModal(userId = null) {
            const modal = document.getElementById('user-modal');
            const modalTitle = document.getElementById('modal-title');
            const userForm = document.getElementById('user-form');
            const passwordGroup = document.getElementById('password-group');
            
            // 重置表单
            userForm.reset();
            document.getElementById('edit-username-error').style.display = 'none';
            
            // 设置模态框标题
            if (userId) {
                modalTitle.textContent = '编辑用户';
                
                // 编辑模式下密码可选
                document.getElementById('edit-password').removeAttribute('required');
                passwordGroup.innerHTML += '<small style="display: block;">留空表示不修改密码</small>';
                
                // 加载用户数据
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.id == userId);
                
                if (user) {
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('edit-fullname').value = user.name;
                    document.getElementById('edit-username').value = user.username;
                    document.getElementById('edit-role').value = user.role;
                    document.getElementById('edit-level').value = user.level;
                    document.getElementById('edit-department').value = user.department || '';
                    document.getElementById('edit-contact').value = user.contact || '';
                }
            } else {
                modalTitle.textContent = '添加用户';
                document.getElementById('edit-password').setAttribute('required', 'required');
                document.getElementById('user-id').value = '';
            }
            
            modal.style.display = 'block';
        }
        
        // 关闭用户编辑模态框
        function closeUserModal() {
            const modal = document.getElementById('user-modal');
            modal.style.display = 'none';
        }
        
        // 检查用户名是否已存在
        function checkUsernameExists(username) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userId = document.getElementById('user-id').value;
            const usernameError = document.getElementById('edit-username-error');
            
            // 排除当前编辑的用户
            const existingUser = users.find(u => u.username === username && u.id != userId);
            
            if (existingUser) {
                usernameError.style.display = 'block';
                return true;
            } else {
                usernameError.style.display = 'none';
                return false;
            }
        }
        
        // 处理用户表单提交
        function handleUserFormSubmit(event) {
            event.preventDefault();
            
            const userId = document.getElementById('user-id').value;
            const username = document.getElementById('edit-username').value.trim();
            const password = document.getElementById('edit-password').value.trim();
            
            // 检查用户名是否已存在
            if (checkUsernameExists(username)) {
                return;
            }
            
            // 如果是新用户或密码已修改，则验证密码强度
            if ((!userId || password) && password.length > 0) {
                const passwordPattern = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/;
                if (!passwordPattern.test(password)) {
                    alert('密码必须至少6位，且包含字母和数字');
                    return;
                }
            }
            
            // 获取表单数据
            const userData = {
                name: document.getElementById('edit-fullname').value.trim(),
                username: username,
                role: document.getElementById('edit-role').value,
                level: document.getElementById('edit-level').value,
                department: document.getElementById('edit-department').value.trim(),
                contact: document.getElementById('edit-contact').value.trim()
            };
            
            // 获取现有用户数据
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            
            if (userId) {
                // 更新现有用户
                const index = users.findIndex(u => u.id == userId);
                if (index !== -1) {
                    // 保留原有ID、密码(如果未修改)和注册时间
                    userData.id = users[index].id;
                    userData.password = password ? password : users[index].password;
                    userData.registerTime = users[index].registerTime;
                    
                    users[index] = userData;
                }
            } else {
                // 添加新用户
                userData.id = Date.now();
                userData.password = password;
                userData.registerTime = new Date().toISOString();
                
                users.push(userData);
            }
            
            // 保存到本地存储
            localStorage.setItem('users', JSON.stringify(users));
            
            // 关闭模态框
            closeUserModal();
            
            // 重新加载用户列表
            loadUserList();
            
            // 提示成功消息
            alert(userId ? '用户更新成功' : '用户添加成功');
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (!confirm('确定要删除该用户吗？此操作不可撤销。')) {
                return;
            }
            
            // 获取现有用户数据
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // 从数组中删除用户
            users = users.filter(user => user.id != userId);
            
            // 保存到本地存储
            localStorage.setItem('users', JSON.stringify(users));
            
            // 重新加载用户列表
            loadUserList();
            
            // 提示成功消息
            alert('用户已成功删除');
        }
    </script>
</body>
</html> 